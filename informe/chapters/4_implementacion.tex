\chapter{Implementación}\label{chapter:implementacion}

Es éste capítulo se describe la implementación del proyecto, a partir de las decisiones de diseño expuestas en el Capítulo \ref{chapter:diseno}. Primero, se presenta la estructuración del software en términos de archivos y paquetes ROS. Luego se muestran los mensajes episódicos sobre los que se construye el proyecto. En tercer lugar, se presentan módulos de software desarrollados para acelerar la implementación y validación del proyecto. Luego, se presenta la implementación del servidor LTM, junto a los módulos encargados de generar información episódica ficticia y los encargados de recolectar datos desde el robot. Finalmente, se muestra la integración del sistema en Bender.

% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
\section{Estructura del software e instalación}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

Esta sección presenta la estructuración del software implementado, en términos de sus archivos y paquetes ROS involucrados. Se describen las dependencias del proyecto, la estructura elegida para el servidor LTM, y la estructura para los plugins encargados de la recolección de información episódica.

\subsection{Dependencias}

A continuación se describen todas las dependencias de software utilizadas para la implementación del proyecto. Éstas se dividen en las siguientes categorías: de sistema, del lenguaje C++, del lenguaje Python y de ROS.

\todoimprove{Añadir versión de cada dependencia.}

\subsubsection{Sistema}

El proyecto fue desarrollado en Linux, Ubuntu 16.04, utilizando la distribución \textit{kinetic} de ROS, la que cuenta con soporte hasta Abril del año 2021. A pesar de lo anterior, el sistema debería ser compatible con versiones más recientes de ROS y Ubuntu, siempre que existan las dependencias mostradas en las siguientes secciones. A continuación se muestra el listado de paquetes extra, requeridos para el funcionamiento del proyecto.

\begin{itemize}
\item {\bfseries mongodb-server}: Paquete de software que contiene el servidor de MongoDB para Ubuntu 16.04.
\end{itemize}


\subsubsection{Dependencias C++}

El servidor fue implementado completamente utilizando C++, bajo el estándar C++03, que es soportado por la mayoría de los compiladores actuales y es el utilizado por defecto en ROS kinetic. A continuación se listan las dependencias de C++ utilizadas para la implementación del servidor.

\begin{itemize}
	\item {\bfseries mongo-cxx-driver}: Driver oficial para mongodb en C++. Más información en su repositorio oficial: \url{https://github.com/mongodb/mongo-cxx-driver.git}. 
	\item {\bfseries Boost Geometry}: Utilizado para el cómputo de la envoltura convexa y para el cálculo del centroide de un polígono.
\end{itemize}


\subsubsection{Dependencias Python}

Se utiliza Python en su versión 2.7, que es el estándar utilizado para ROS kinetic. Ya que el servidor está completamente implementado en C++, las siguientes dependencias son sólo para los módulos específicos para la integración con Bender o para el software demostrativo.

\begin{itemize}
\item {\bfseries cv2}: Librería OpenCV 2. Utilizada para insertar imágenes ficticias en entidades. 
\item {\bfseries faker}: Librería utilizada para la generación de datos ficticios para entidades. Más información en su web oficial: \url{https://github.com/joke2k/faker}.
\end{itemize}

\todoimplementation{Mover JSON loader fuera del package principal?}

\subsubsection{Dependencias ROS}

A continuación se listan las dependencias de paquetes ROS utilizados para la implementación del servidor.
\begin{itemize}
	\item Suite estándar de mensajes y servicios: std\_srvs, std\_msgs, geometry\_msgs, sensor\_msgs.
	\item {\bfseries pluginlib}: Librería estándar para la implementación de plugins en ROS.
	\item {\bfseries warehouse\_ros\_mongo}: Interfaz ROS para el almacenamiento de mensajes en MongoDB. Es una librería estándar, pero por errores al actualizar versiones de ROS, el paquete aún no está disponible en el canal oficial para ROS kinetic. Más información en el repositorio oficial: \url{https://github.com/ros-planning/warehouse\_ros\_mongo}.
\end{itemize}

Las siguientes dependencias extra, son paquetes ROS utilizados para la implementación de componentes específicas para el robot Bender y para el software demostrativo.
\begin{itemize}
\item {\bfseries smach, smach\_ros}: Librería SMACH. Utilizada para la implementación de la interfaz episódica con máquinas de estado.
\item {\bfseries cv\_bridge}: Interfaz ROS con librería OpenCV. Utilizado para el manejo de imágenes en los plugins.
\end{itemize}
\todopaused{Actualizar dependencias tras integración.}


\subsection{Paquetes de software desarrollados}

Con el motivo de separar conceptos e implementar un software independiente del robot objetivo, se desarrollaron 5 paquetes ROS. Uno de ellos contiene solamente la implementación del servidor, otro provee plugins e interfaces episódicas genéricas, otro contiene código de ejemplo, para pruebas y validación. Los dos últimos contienen implementaciones específicas para el robot Bender.

Todos los paquetes de ROS implementados cuentan con un repositorio de software en GitHub, de carácter público.

\subsubsection{Paquete ROS: \texttt{ltm}}

Contiene solamente la implementación del servidor y la documentación de éste. No se incluyen plugins ni interfaces episódicas, pues son consideradas como software no necesario o muy específico para un robot, como para ser considerado genérico. El paquete se puede encontrar en el siguiente repositorio público de software: \url{https://github.com/mpavezb/ltm}.

\subsubsection{Paquete ROS: \texttt{ltm\_addons}}

Este paquete ROS implementa el plugin para adquisición de imágenes y las interfaces episódicas para JSON y SMACH. Contiene software genérico, agnóstico del robot a utilizar. Los tres componentes anteriores pueden ser considerados herramientas útiles para algún robot, pero que no son estrictamente necesarios para el funcionamiento del servidor LTM. El repositorio asociado se puede encontrar en: \url{https://github.com/mpavezb/ltm\_addons}.

\subsubsection{Paquete ROS: \texttt{ltm\_samples}}

Este paquete contiene implementaciones de ejemplo de algunos plugins episódicos, capaces de generar información ficticia. Además, el paquete contiene software útil para pruebas del funcionamiento del servidor y código para su validación. Su repositorio de software se encuentra en: \url{https://github.com/mpavezb/ltm\_samples}.

\subsubsection{Paquete ROS: \texttt{bender\_emotion}}

Ya que Bender no dispone de un software generador de emociones, este paquete implementa el sistema descrito en la Sección \ref{}. El repositorio se encuentra alojado en la cuenta GitHub del equipo encargado de Bender: \url{https://github.com/uchile-robotics/bender\_emotion}.

\subsubsection{Paquete ROS: \texttt{bender\_ltm}}

Este paquete implementa plugins específicos para el uso del sistema LTM en el robot Bender, y es considerado el punto de integración del proyecto con el robot. Similarmente al paquete \texttt{bender\_emotion}, su repositorio se encuentra alojado en: \url{https://github.com/uchile-robotics/bender\_ltm}.




\subsection{Detalles del software}

\todowrite{Incluir figura con diagrama de funcionamiento del server - robot.}

\todowrite{Ver en que puntos se pueden agregar diagramas y figuras explicativas.}

\todowrite{Incluir tabla con Líneas de código por lenguaje... ver memoria de IAN. Usar comando: \texttt{\$ cloc ltm ltm\_samples}}


\subsection{Documentación}

El software desarrollado para el servidor (paquete \texttt{ltm}), junto a los plugins de ejemplo para recopilación de información ficticia (paquete \texttt{ltm\_samples}), y las interfaz episódica en SMACH (paquete \texttt{ltm\_addons}), se encuentra documentado en el archivo \texttt{README.md} del repositorio de software `ltm`, disponible en  \url{https://github.com/mpavezb/ltm}.

La documentación incluye una guía de instalación del proyecto y sus dependencias, junto a un tutorial sobre el uso del servidor y la elaboración de plugins.

\todoimplementation{Completar tutoriales o quitarlos del informe.}


% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
\section{Mensajes episódicos}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

En ésta sección se muestran los mensajes ROS implementados para manejar el concepto de episodios, los que son la base sobre la que se construye el sistema LTM y definen la estructura episódica a utilizar para la comunicación entre los clientes y el servidor en ROS.

\todounsure{Pongo código fuente de todos los mensajes definidos?.. los pongo en los anexos?.. son 3 páginas de sólo código!!}


% \ref{lst:episode.msg}
\subsection{Mensajes definidos por el servidor}

\lstset{style=/Style/ROS/MSG}
\lstinputlisting[caption=ltm/Episode.msg,label=lst:episode.msg]{code/msg/Episode.msg}
\lstinputlisting[caption=ltm/When.msg]{code/msg/When.msg}
\lstinputlisting[caption=ltm/Where.msg]{code/msg/Where.msg}
\lstinputlisting[caption=ltm/What.msg]{code/msg/What.msg}
\lstinputlisting[caption=ltm/Info.msg]{code/msg/Info.msg}
\lstinputlisting[caption=ltm/Relevance.msg]{code/msg/Relevance.msg}
\lstinputlisting[caption=ltm/EmotionalRelevance.msg]{code/msg/EmotionalRelevance.msg}
\lstinputlisting[caption=ltm/HistoricalRelevance.msg]{code/msg/HistoricalRelevance.msg}

\subsection{Mensajes definidos por los plugins para Bender}

\lstset{style=/Style/ROS/MSG}
\lstinputlisting[caption=ltm\_samples/ImageStream.msg]{code/msg/ImageStream.msg}
\lstinputlisting[caption=ltm\_samples/PersonEntity.msg]{code/msg/PersonEntity.msg}
\lstinputlisting[caption=ltm\_samples/PersonState.msg]{code/msg/PersonState.msg}
\lstinputlisting[caption=ltm\_samples/ObjectEntity.msg]{code/msg/ObjectEntity.msg}
\lstinputlisting[caption=ltm\_samples/ObjectState.msg]{code/msg/ObjectState.msg}
%\lstinputlisting[caption=ltm\_samples/PlaceEntity.msg]{code/msg/PlaceEntity.msg}
%\lstinputlisting[caption=ltm\_samples/RobotEntity.msg]{code/msg/RobotEntity.msg}
%\lstinputlisting[caption=ltm\_samples/RobotState.msg]{code/msg/RobotState.msg}

% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
\section{Herramientas para validación}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

\subsection{Episodios JSON}
% - Episodios JSON: comprensión de la estructura a utilizar
.

\subsection{Episodios SMACH}
% - Episodios Smach: cubrir todos los casos de borde
.

\subsection{Robot ficticio}
% generar datos para plugins

% - Robot simulado: emociones y localización fakes

% - Streams Fake: videos.. proveer misma interfaz que el robot

% - Entidades Fake: Generador de campos para mensajes ... no existe interfaz en el robot para esto.

.

% ==============================================================================
% ==============================================================================\\
% ==============================================================================
% ==============================================================================
\section{Servidor LTM}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

.
% OVERVIEW
% uso de diseño explicado en la sección X
% implementación completa en C++
% sobre el manejo de la BD episódica utilizando el driver X

% MANEJO DE PLUGINS
% ==============================================================================
% ==============================================================================
\subsection{API pluginlib}
% ==============================================================================
% ==============================================================================

.
\subsubsection{Plugin: \textit{Where}}
% - API
% - convex hull

.
\subsubsection{Plugin: Emociones}
% - API

.
\subsubsection{Plugin: Streams}
% - API
% - Manejo de coleccion

.
\subsubsection{Plugin: Entidades}
% - Manejo de colecciones
% - API

.

% ==============================================================================
% ==============================================================================
\subsection{API ROS}
% ==============================================================================
% ==============================================================================
% API ROS:
% - Disponible a través de C++, Python, Java, Lisp, otros.

.

\subsubsection{Servicios implementados}
% - srv implementados
% - Servicios que provee

\lstset{style=/Style/ROS/MSG}
\lstinputlisting[caption=ltm/RegisterEpisode.srv]{code/srv/RegisterEpisode.srv}
\lstinputlisting[caption=ltm/AddEpisode.srv]{code/srv/AddEpisode.srv}
\lstinputlisting[caption=ltm/GetEpisode.srv]{code/srv/GetEpisode.srv}
\lstinputlisting[caption=ltm/UpdateTree.srv]{code/srv/UpdateTree.srv}


\subsubsection{Consultas episódicas}
% - consultas episódicas

.

\subsubsection{Configuración mediante ROS}

.
\lstset{style=/Style/yaml/ROS}
\lstinputlisting[caption=server.yaml]{code/config/server.yaml}
\todounsure{Listing en los anexos??}

\subsubsection{Launchfiles}



% ==============================================================================
% ==============================================================================
\subsection{Trabajo futuro}
% ==============================================================================
% ==============================================================================
% Trabajo Futuro

.



% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
\section{Módulos generadores de información ficticia}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

.


% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de \textit{Where}}
% ==============================================================================
% ==============================================================================
% WHERE
% - sólo genera al recolectar... no requiere almacenar buffer
% - configurable
% - Registro en pluginlib y configuración en el server

.


% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de emociones}
% ==============================================================================
% ==============================================================================
% EMOTIONS
% - sólo genera al recolectar... no requiere almacenar buffer
% - configurable
% - Registro en pluginlib y configuración en el server

.



% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de imágenes}
% ==============================================================================
% ==============================================================================
% STREAMS EN VIDEO
% - buffer
% - configurable
% - Registro en pluginlib y configuración en el server

\lstset{style=/Style/ROS/MSG}
\lstinputlisting[caption=ltm\_samples/ImageStreamSrv.srv]{code/srv/ImageStreamSrv.srv}

.


% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de entidades}
% ==============================================================================
% ==============================================================================
% ENTIDADES
% - sólo genera al recolectar... no requiere almacenar buffer
% - configurable
% - Registro en pluginlib y configuración en el server

.



% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
\section{Módulos específicos para Bender}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================

.


% ==============================================================================
% ==============================================================================
\subsection{Interfaz con SMACH}
% ==============================================================================
% ==============================================================================
% INTERFAZ SMACH
% - SOBRE DISEÑO y PYTHON
% - implementación:
%   - registro de episodios y tags
%   - hooks para inicio y fin de episodios
%   - intrusividad: Implementación sin impacto en librería y que minimiza trabajo del equipo
%   - estabilidad: no morir ante nada!
% - test en todos los tipos de estado definidos?
% - ejemplo de funcionamiento
% - REVISAR MATCH CON DISEÑO ESCRITO

.



% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de \textit{Where}}
% ==============================================================================
% ==============================================================================
% INTERFAZ WHERE
% - API del ROBOT
% - buffer y periodicidad
% - selección de posiciones
% - registro y recolección
% - Registro en pluginlib y configuración en el server
% - REVISAR MATCH CON DISEÑO ESCRITO
.
\todopaused{Escribir cuando esté implementado}


% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de emociones}
% ==============================================================================
% ==============================================================================
% INTERFAZ EMOTIONS
% - API del ROBOT
% - buffer y periodicidad
% - selección de emocion
% - metadatos
% - registro y recolección
% - Registro en pluginlib y configuración en el server
% - REVISAR MATCH CON DISEÑO ESCRITO
% - Funcionalidades implementadas en el robot: 
%    - emociones simples.
%    - módulos disponibles (con el robot a medias)
.
\todopaused{Escribir cuando esté implementado}


% ==============================================================================
% ==============================================================================
\subsection{Plugin para recolección de imágenes}
% ==============================================================================
% ==============================================================================
% INTERFAZ IMAGES
% - API del ROBOT
.
\todopaused{Escribir cuando esté implementado}


% ==============================================================================
% ==============================================================================
\subsection{Plugins para recolección de entidades}
% ==============================================================================
% ==============================================================================
% INTERFAZ ENTITIES
% - API del ROBOT
.
\todopaused{Escribir cuando esté implementado}


% ==============================================================================
% ==============================================================================\\
% ==============================================================================
% ==============================================================================
\section{Integración del sistema en Bender}
% ==============================================================================
% ==============================================================================
% ==============================================================================
% ==============================================================================
% - instalación y convivencia con el software
% - visualización de datos episódicos.
% - Interfaz Robot: Emociones y Posición
% - Streams
% - Entidades

.
